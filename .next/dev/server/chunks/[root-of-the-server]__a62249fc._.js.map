{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/lib/permissions.ts"],"sourcesContent":["/**\n * Role-Based Access Control (RBAC) System\n * \n * Role Hierarchy:\n * 1. Super Admin - Platform owner, manages all schools\n * 2. Principal - School-level admin, manages their school\n * 3. Teacher - Manages assigned classes and subjects\n * 4. Student - View-only access to their own data\n */\n\nexport type UserRole = 'super-admin' | 'principal' | 'teacher' | 'student';\n\nexport interface Permission {\n  resource: string;\n  action: 'create' | 'read' | 'update' | 'delete' | 'manage';\n  scope?: 'all' | 'school' | 'own' | 'assigned';\n}\n\n// Define permissions for each role\nexport const rolePermissions: Record<UserRole, Permission[]> = {\n  'super-admin': [\n    // Full platform access\n    { resource: 'schools', action: 'manage', scope: 'all' },\n    { resource: 'users', action: 'manage', scope: 'all' },\n    { resource: 'principals', action: 'create', scope: 'all' },\n    { resource: 'principals', action: 'manage', scope: 'all' },\n    { resource: 'billing', action: 'manage', scope: 'all' },\n    { resource: 'analytics', action: 'read', scope: 'all' },\n    { resource: 'reports', action: 'read', scope: 'all' },\n    { resource: 'school-registrations', action: 'manage', scope: 'all' },\n  ],\n  \n  'principal': [\n    // School-level management\n    { resource: 'school', action: 'read', scope: 'own' },\n    { resource: 'school', action: 'update', scope: 'own' },\n    { resource: 'teachers', action: 'create', scope: 'school' },\n    { resource: 'teachers', action: 'manage', scope: 'school' },\n    { resource: 'students', action: 'create', scope: 'school' },\n    { resource: 'students', action: 'manage', scope: 'school' },\n    { resource: 'classes', action: 'manage', scope: 'school' },\n    { resource: 'subjects', action: 'manage', scope: 'school' },\n    { resource: 'attendance', action: 'read', scope: 'school' },\n    { resource: 'marks', action: 'read', scope: 'school' },\n    { resource: 'reports', action: 'read', scope: 'school' },\n    { resource: 'stats', action: 'read', scope: 'school' },\n    { resource: 'analytics', action: 'read', scope: 'school' },\n    { resource: 'timetable', action: 'manage', scope: 'school' },\n    { resource: 'courses', action: 'manage', scope: 'school' },\n  ],\n  \n  'teacher': [\n    // Class and subject specific access\n    { resource: 'school', action: 'read', scope: 'own' }, // Read-only school info\n    { resource: 'students', action: 'read', scope: 'assigned' }, // Only their class students\n    { resource: 'classes', action: 'read', scope: 'assigned' },\n    { resource: 'subjects', action: 'read', scope: 'assigned' },\n    { resource: 'homework', action: 'manage', scope: 'assigned' },\n    { resource: 'attendance', action: 'create', scope: 'assigned' },\n    { resource: 'attendance', action: 'read', scope: 'assigned' },\n    { resource: 'marks', action: 'create', scope: 'assigned' },\n    { resource: 'marks', action: 'update', scope: 'assigned' },\n    { resource: 'marks', action: 'read', scope: 'assigned' },\n    { resource: 'timetable', action: 'read', scope: 'assigned' },\n    { resource: 'courses', action: 'read', scope: 'assigned' },\n    { resource: 'quizzes', action: 'read', scope: 'assigned' }, // View quiz responses\n  ],\n  \n  'student': [\n    // Personal dashboard only\n    { resource: 'profile', action: 'read', scope: 'own' },\n    { resource: 'profile', action: 'update', scope: 'own' },\n    { resource: 'class', action: 'read', scope: 'own' },\n    { resource: 'subjects', action: 'read', scope: 'own' },\n    { resource: 'teachers', action: 'read', scope: 'own' },\n    { resource: 'homework', action: 'read', scope: 'own' },\n    { resource: 'attendance', action: 'read', scope: 'own' },\n    { resource: 'marks', action: 'read', scope: 'own' },\n    { resource: 'timetable', action: 'read', scope: 'own' },\n    { resource: 'courses', action: 'read', scope: 'own' },\n    { resource: 'quizzes', action: 'read', scope: 'own' },\n    { resource: 'quizzes', action: 'create', scope: 'own' }, // Submit quiz responses\n    { resource: 'school', action: 'read', scope: 'own' }, // Basic school info only\n  ],\n};\n\n/**\n * Check if a user has permission to perform an action\n */\nexport function hasPermission(\n  userRole: UserRole,\n  resource: string,\n  action: 'create' | 'read' | 'update' | 'delete' | 'manage',\n  scope?: 'all' | 'school' | 'own' | 'assigned'\n): boolean {\n  const permissions = rolePermissions[userRole];\n  \n  return permissions.some(permission => {\n    // Check if resource matches\n    const resourceMatch = permission.resource === resource;\n    \n    // Check if action matches (manage includes all actions)\n    const actionMatch = \n      permission.action === action || \n      permission.action === 'manage';\n    \n    // Check if scope matches (if scope is specified)\n    const scopeMatch = !scope || permission.scope === scope || permission.scope === 'all';\n    \n    return resourceMatch && actionMatch && scopeMatch;\n  });\n}\n\n/**\n * Check if user can access a school's data\n */\nexport function canAccessSchool(\n  userRole: UserRole,\n  userSchoolId: string | undefined,\n  targetSchoolId: string\n): boolean {\n  // Super admin can access all schools\n  if (userRole === 'super-admin') {\n    return true;\n  }\n  \n  // Others can only access their own school\n  return userSchoolId === targetSchoolId;\n}\n\n/**\n * Check if user can access another user's data\n */\nexport function canAccessUser(\n  userRole: UserRole,\n  userId: string,\n  targetUserId: string,\n  userSchoolId: string | undefined,\n  targetUserSchoolId: string | undefined,\n  targetUserRole?: UserRole\n): boolean {\n  // Super admin can access all users\n  if (userRole === 'super-admin') {\n    return true;\n  }\n  \n  // Users can always access their own data\n  if (userId === targetUserId) {\n    return true;\n  }\n  \n  // Principal can access all users in their school\n  if (userRole === 'principal' && userSchoolId === targetUserSchoolId) {\n    return true;\n  }\n  \n  // Teachers can access students in their school (will be further filtered by assigned classes)\n  if (\n    userRole === 'teacher' && \n    targetUserRole === 'student' && \n    userSchoolId === targetUserSchoolId\n  ) {\n    return true;\n  }\n  \n  return false;\n}\n\n/**\n * Filter data based on user's role and scope\n */\nexport function getAccessibleSchoolIds(\n  userRole: UserRole,\n  userSchoolId: string | undefined\n): string[] | 'all' {\n  if (userRole === 'super-admin') {\n    return 'all';\n  }\n  \n  if (userSchoolId) {\n    return [userSchoolId];\n  }\n  \n  return [];\n}\n\n/**\n * Get user-friendly role names\n */\nexport const roleLabels: Record<UserRole, string> = {\n  'super-admin': 'Super Administrator',\n  'principal': 'Principal / Head of School',\n  'teacher': 'Teacher',\n  'student': 'Student',\n};\n\n/**\n * Get role descriptions\n */\nexport const roleDescriptions: Record<UserRole, string> = {\n  'super-admin': 'Platform owner with full access to all schools and features',\n  'principal': 'School administrator with full control over their school',\n  'teacher': 'Can manage assigned classes, subjects, and student data',\n  'student': 'View-only access to personal academic information',\n};\n\n/**\n * Get dashboard route based on role\n */\nexport function getDashboardRoute(role: UserRole): string {\n  switch (role) {\n    case 'super-admin':\n      return '/admin/dashboard';\n    case 'principal':\n      return '/principal/dashboard';\n    case 'teacher':\n      return '/teacher/dashboard';\n    case 'student':\n      return '/student/dashboard';\n    default:\n      return '/';\n  }\n}\n\n/**\n * Check if role can create users of target role\n */\nexport function canCreateRole(\n  userRole: UserRole,\n  targetRole: UserRole\n): boolean {\n  if (userRole === 'super-admin') {\n    // Super admin can create principals and approve schools\n    return ['principal', 'super-admin'].includes(targetRole);\n  }\n  \n  if (userRole === 'principal') {\n    // Principal can create teachers and students\n    return ['teacher', 'student'].includes(targetRole);\n  }\n  \n  return false;\n}\n\n/**\n * Middleware helper for API routes\n */\nexport function requireRole(allowedRoles: UserRole[]) {\n  return (userRole: UserRole) => {\n    return allowedRoles.includes(userRole);\n  };\n}\n\n/**\n * Check if user has elevated privileges\n */\nexport function isAdmin(role: UserRole): boolean {\n  return ['super-admin', 'principal'].includes(role);\n}\n\n/**\n * Check if user is super admin\n */\nexport function isSuperAdmin(role: UserRole): boolean {\n  return role === 'super-admin';\n}\n\n/**\n * Check if user is principal\n */\nexport function isPrincipal(role: UserRole): boolean {\n  return role === 'principal';\n}\n\n/**\n * Check if user is teacher\n */\nexport function isTeacher(role: UserRole): boolean {\n  return role === 'teacher';\n}\n\n/**\n * Check if user is student\n */\nexport function isStudent(role: UserRole): boolean {\n  return role === 'student';\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 465, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/lib/auth-middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { UserRole, canAccessSchool, hasPermission } from './permissions';\n\nexport interface AuthUser {\n  id: string;\n  role: UserRole;\n  name: string;\n  email: string;\n  schoolId?: string;\n}\n\n/**\n * Get authenticated user from request cookies\n */\nexport function getAuthUser(request: NextRequest): AuthUser | null {\n  try {\n    const cookie = request.cookies.get('edubridge_session');\n    if (!cookie?.value) {\n      return null;\n    }\n    \n    const session = JSON.parse(cookie.value);\n    return {\n      id: session.id,\n      role: session.role as UserRole,\n      name: session.name,\n      email: session.email,\n      schoolId: session.schoolId,\n    };\n  } catch (error) {\n    return null;\n  }\n}\n\n/**\n * Require authentication - returns 401 if not authenticated\n */\nexport function requireAuth(request: NextRequest): AuthUser | NextResponse {\n  const user = getAuthUser(request);\n  \n  if (!user) {\n    return NextResponse.json(\n      { success: false, error: 'Authentication required' },\n      { status: 401 }\n    );\n  }\n  \n  return user;\n}\n\n/**\n * Require specific role(s) - returns 403 if not authorized\n */\nexport function requireRoles(\n  user: AuthUser,\n  allowedRoles: UserRole[]\n): true | NextResponse {\n  if (!allowedRoles.includes(user.role)) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Insufficient permissions',\n        message: `This action requires one of the following roles: ${allowedRoles.join(', ')}`\n      },\n      { status: 403 }\n    );\n  }\n  \n  return true;\n}\n\n/**\n * Require permission for a resource and action\n */\nexport function requirePermission(\n  user: AuthUser,\n  resource: string,\n  action: 'create' | 'read' | 'update' | 'delete' | 'manage',\n  scope?: 'all' | 'school' | 'own' | 'assigned'\n): true | NextResponse {\n  if (!hasPermission(user.role, resource, action, scope)) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Insufficient permissions',\n        message: `You don't have permission to ${action} ${resource}`\n      },\n      { status: 403 }\n    );\n  }\n  \n  return true;\n}\n\n/**\n * Require school access - returns 403 if user can't access the school\n */\nexport function requireSchoolAccess(\n  user: AuthUser,\n  targetSchoolId: string\n): true | NextResponse {\n  if (!canAccessSchool(user.role, user.schoolId, targetSchoolId)) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Access denied',\n        message: 'You do not have access to this school'\n      },\n      { status: 403 }\n    );\n  }\n  \n  return true;\n}\n\n/**\n * Require same school - ensures user and target are in same school\n */\nexport function requireSameSchool(\n  user: AuthUser,\n  targetSchoolId: string | undefined\n): true | NextResponse {\n  // Super admin can access all schools\n  if (user.role === 'super-admin') {\n    return true;\n  }\n  \n  if (!user.schoolId || !targetSchoolId) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'School information missing',\n      },\n      { status: 400 }\n    );\n  }\n  \n  if (user.schoolId !== targetSchoolId) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Access denied',\n        message: 'You can only access users in your school'\n      },\n      { status: 403 }\n    );\n  }\n  \n  return true;\n}\n\n/**\n * Helper to handle auth checks in API routes\n * Returns user if all checks pass, otherwise returns NextResponse error\n */\nexport function authenticateAndAuthorize(\n  request: NextRequest,\n  options: {\n    requiredRoles?: UserRole[];\n    resource?: string;\n    action?: 'create' | 'read' | 'update' | 'delete' | 'manage';\n    scope?: 'all' | 'school' | 'own' | 'assigned';\n  } = {}\n): AuthUser | NextResponse {\n  // Check authentication\n  const authResult = requireAuth(request);\n  if (authResult instanceof NextResponse) {\n    return authResult;\n  }\n  \n  const user = authResult;\n  \n  // Check role if specified\n  if (options.requiredRoles) {\n    const roleCheck = requireRoles(user, options.requiredRoles);\n    if (roleCheck instanceof NextResponse) {\n      return roleCheck;\n    }\n  }\n  \n  // Check permission if specified\n  if (options.resource && options.action) {\n    const permCheck = requirePermission(\n      user,\n      options.resource,\n      options.action,\n      options.scope\n    );\n    if (permCheck instanceof NextResponse) {\n      return permCheck;\n    }\n  }\n  \n  return user;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 608, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/lib/models/Mark.ts"],"sourcesContent":["import mongoose, { Document, Schema } from 'mongoose';\n\nexport interface IMark extends Document {\n  studentId: mongoose.Types.ObjectId;\n  schoolId: mongoose.Types.ObjectId;\n  examId: mongoose.Types.ObjectId;\n  subjectId: mongoose.Types.ObjectId;\n  marksScored: number;\n  totalMarks?: number;\n  percentage?: number;\n  grade?: string;\n  remarks?: string;\n  markedBy?: mongoose.Types.ObjectId; // Teacher who entered marks\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nconst MarkSchema = new Schema<IMark>(\n  {\n    studentId: {\n      type: Schema.Types.ObjectId,\n      ref: 'User',\n      required: [true, 'Student ID is required'],\n      index: true,\n    },\n    schoolId: {\n      type: Schema.Types.ObjectId,\n      ref: 'School',\n      required: [true, 'School ID is required'],\n      index: true,\n    },\n    examId: {\n      type: Schema.Types.ObjectId,\n      ref: 'Exam',\n      required: [true, 'Exam ID is required'],\n      index: true,\n    },\n    subjectId: {\n      type: Schema.Types.ObjectId,\n      ref: 'Subject',\n      required: [true, 'Subject ID is required'],\n      index: true,\n    },\n    marksScored: {\n      type: Number,\n      required: [true, 'Marks scored is required'],\n      min: 0,\n    },\n    totalMarks: {\n      type: Number,\n      min: 1,\n    },\n    percentage: {\n      type: Number,\n      min: 0,\n      max: 100,\n    },\n    grade: {\n      type: String,\n      trim: true,\n    },\n    remarks: {\n      type: String,\n      trim: true,\n      maxlength: 500,\n    },\n    markedBy: {\n      type: Schema.Types.ObjectId,\n      ref: 'User',\n    },\n  },\n  {\n    timestamps: true,\n  }\n);\n\n// Compound indexes for efficient queries\nMarkSchema.index({ schoolId: 1, examId: 1 });\nMarkSchema.index({ studentId: 1, examId: 1, subjectId: 1 }, { unique: true });\nMarkSchema.index({ examId: 1, subjectId: 1 });\n\n// Pre-save hook to calculate percentage and grade\nMarkSchema.pre('save', function () {\n  if (this.marksScored !== undefined && this.totalMarks !== undefined) {\n    this.percentage = (this.marksScored / this.totalMarks) * 100;\n    \n    // Calculate grade based on percentage\n    if (this.percentage >= 90) this.grade = 'A+';\n    else if (this.percentage >= 80) this.grade = 'A';\n    else if (this.percentage >= 70) this.grade = 'B+';\n    else if (this.percentage >= 60) this.grade = 'B';\n    else if (this.percentage >= 50) this.grade = 'C';\n    else if (this.percentage >= 40) this.grade = 'D';\n    else this.grade = 'F';\n  }\n});\n\nexport default mongoose.models.Mark || mongoose.model<IMark>('Mark', MarkSchema);\n"],"names":[],"mappings":";;;;AAAA;;AAiBA,MAAM,aAAa,IAAI,mHAAM,CAC3B;IACE,WAAW;QACT,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,UAAU;YAAC;YAAM;SAAyB;QAC1C,OAAO;IACT;IACA,UAAU;QACR,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,UAAU;YAAC;YAAM;SAAwB;QACzC,OAAO;IACT;IACA,QAAQ;QACN,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,UAAU;YAAC;YAAM;SAAsB;QACvC,OAAO;IACT;IACA,WAAW;QACT,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,UAAU;YAAC;YAAM;SAAyB;QAC1C,OAAO;IACT;IACA,aAAa;QACX,MAAM;QACN,UAAU;YAAC;YAAM;SAA2B;QAC5C,KAAK;IACP;IACA,YAAY;QACV,MAAM;QACN,KAAK;IACP;IACA,YAAY;QACV,MAAM;QACN,KAAK;QACL,KAAK;IACP;IACA,OAAO;QACL,MAAM;QACN,MAAM;IACR;IACA,SAAS;QACP,MAAM;QACN,MAAM;QACN,WAAW;IACb;IACA,UAAU;QACR,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;IACP;AACF,GACA;IACE,YAAY;AACd;AAGF,yCAAyC;AACzC,WAAW,KAAK,CAAC;IAAE,UAAU;IAAG,QAAQ;AAAE;AAC1C,WAAW,KAAK,CAAC;IAAE,WAAW;IAAG,QAAQ;IAAG,WAAW;AAAE,GAAG;IAAE,QAAQ;AAAK;AAC3E,WAAW,KAAK,CAAC;IAAE,QAAQ;IAAG,WAAW;AAAE;AAE3C,kDAAkD;AAClD,WAAW,GAAG,CAAC,QAAQ;IACrB,IAAI,IAAI,CAAC,WAAW,KAAK,aAAa,IAAI,CAAC,UAAU,KAAK,WAAW;QACnE,IAAI,CAAC,UAAU,GAAG,AAAC,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,UAAU,GAAI;QAEzD,sCAAsC;QACtC,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,IAAI,CAAC,KAAK,GAAG;aACnC,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,IAAI,CAAC,KAAK,GAAG;aACxC,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,IAAI,CAAC,KAAK,GAAG;aACxC,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,IAAI,CAAC,KAAK,GAAG;aACxC,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,IAAI,CAAC,KAAK,GAAG;aACxC,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,IAAI,CAAC,KAAK,GAAG;aACxC,IAAI,CAAC,KAAK,GAAG;IACpB;AACF;uCAEe,oHAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,oHAAQ,CAAC,KAAK,CAAQ,QAAQ"}},
    {"offset": {"line": 719, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/lib/models/User.ts"],"sourcesContent":["import mongoose, { Document, Model, Schema } from 'mongoose';\n\nexport interface IUser extends Document {\n  _id: string;\n  name: string;\n  email: string;\n  password: string;\n  role: 'super-admin' | 'principal' | 'teacher' | 'student';\n  schoolId?: mongoose.Types.ObjectId;\n  avatar?: string;\n  bio?: string;\n  phone?: string;\n  isActive: boolean;\n  // Teacher-specific fields\n  subjectSpecialization?: string;\n  teacherRole?: 'Teacher' | 'HOD' | 'Vice Principal';\n  assignedClasses?: mongoose.Types.ObjectId[]; // Array of Class IDs\n  assignedSubjects?: mongoose.Types.ObjectId[]; // Array of Subject IDs\n  // Student-specific fields\n  classId?: mongoose.Types.ObjectId; // Reference to Class model\n  rollNo?: number;\n  parentName?: string;\n  parentPhone?: string;\n  // Legacy fields (for backward compatibility)\n  className?: string; // e.g., '10-A'\n  section?: string; // e.g., 'A', 'B', 'C', 'D', 'E'\n  rollNumber?: string;\n  enrolledCourses?: mongoose.Types.ObjectId[];\n  // Teacher fields\n  createdCourses?: mongoose.Types.ObjectId[];\n  progress?: {\n    courseId: mongoose.Types.ObjectId;\n    completedLessons: number;\n    totalLessons: number;\n    lastAccessed: Date;\n  }[];\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nconst UserSchema = new Schema<IUser>(\n  {\n    name: {\n      type: String,\n      required: [true, 'Please provide a name'],\n      trim: true,\n      maxlength: [100, 'Name cannot be more than 100 characters'],\n    },\n    email: {\n      type: String,\n      required: [true, 'Please provide an email'],\n      unique: true,\n      lowercase: true,\n      trim: true,\n      match: [\n        /^\\w+([\\.-]?\\w+)*@\\w+([\\.-]?\\w+)*(\\.\\w{2,3})+$/,\n        'Please provide a valid email',\n      ],\n    },\n    password: {\n      type: String,\n      required: [true, 'Please provide a password'],\n      minlength: [6, 'Password must be at least 6 characters'],\n      select: false, // Don't return password by default\n    },\n    role: {\n      type: String,\n      enum: ['super-admin', 'principal', 'teacher', 'student'],\n      default: 'student',\n      required: true,\n    },\n    schoolId: {\n      type: Schema.Types.ObjectId,\n      ref: 'School',\n    },\n    avatar: {\n      type: String,\n      default: '',\n    },\n    bio: {\n      type: String,\n      maxlength: [500, 'Bio cannot be more than 500 characters'],\n    },\n    phone: {\n      type: String,\n      trim: true,\n    },\n    isActive: {\n      type: Boolean,\n      default: true,\n    },\n    // Teacher-specific fields\n    subjectSpecialization: {\n      type: String,\n      trim: true,\n    },\n    teacherRole: {\n      type: String,\n      enum: ['Teacher', 'HOD', 'Vice Principal'],\n    },\n    assignedClasses: [\n      {\n        type: Schema.Types.ObjectId,\n        ref: 'Class',\n      },\n    ],\n    assignedSubjects: [\n      {\n        type: Schema.Types.ObjectId,\n        ref: 'Subject',\n      },\n    ],\n    // Student-specific fields\n    classId: {\n      type: Schema.Types.ObjectId,\n      ref: 'Class',\n      index: true,\n    },\n    rollNo: {\n      type: Number,\n      min: 1,\n    },\n    parentName: {\n      type: String,\n      trim: true,\n    },\n    parentPhone: {\n      type: String,\n      trim: true,\n    },\n    // Legacy fields (backward compatibility)\n    className: {\n      type: String,\n      trim: true,\n    },\n    section: {\n      type: String,\n      trim: true,\n    },\n    rollNumber: {\n      type: String,\n      trim: true,\n    },\n    enrolledCourses: [\n      {\n        type: Schema.Types.ObjectId,\n        ref: 'Course',\n      },\n    ],\n    createdCourses: [\n      {\n        type: Schema.Types.ObjectId,\n        ref: 'Course',\n      },\n    ],\n    progress: [\n      {\n        courseId: {\n          type: Schema.Types.ObjectId,\n          ref: 'Course',\n        },\n        completedLessons: {\n          type: Number,\n          default: 0,\n        },\n        totalLessons: {\n          type: Number,\n          default: 0,\n        },\n        lastAccessed: {\n          type: Date,\n          default: Date.now,\n        },\n      },\n    ],\n  },\n  {\n    timestamps: true,\n  }\n);\n\n// Indexes for better query performance\nUserSchema.index({ role: 1 });\nUserSchema.index({ schoolId: 1, role: 1 });\n// email already has unique index from schema definition\n\nconst User: Model<IUser> =\n  mongoose.models.User || mongoose.model<IUser>('User', UserSchema);\n\nexport default User;\n"],"names":[],"mappings":";;;;AAAA;;AAwCA,MAAM,aAAa,IAAI,mHAAM,CAC3B;IACE,MAAM;QACJ,MAAM;QACN,UAAU;YAAC;YAAM;SAAwB;QACzC,MAAM;QACN,WAAW;YAAC;YAAK;SAA0C;IAC7D;IACA,OAAO;QACL,MAAM;QACN,UAAU;YAAC;YAAM;SAA0B;QAC3C,QAAQ;QACR,WAAW;QACX,MAAM;QACN,OAAO;YACL;YACA;SACD;IACH;IACA,UAAU;QACR,MAAM;QACN,UAAU;YAAC;YAAM;SAA4B;QAC7C,WAAW;YAAC;YAAG;SAAyC;QACxD,QAAQ;IACV;IACA,MAAM;QACJ,MAAM;QACN,MAAM;YAAC;YAAe;YAAa;YAAW;SAAU;QACxD,SAAS;QACT,UAAU;IACZ;IACA,UAAU;QACR,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;IACP;IACA,QAAQ;QACN,MAAM;QACN,SAAS;IACX;IACA,KAAK;QACH,MAAM;QACN,WAAW;YAAC;YAAK;SAAyC;IAC5D;IACA,OAAO;QACL,MAAM;QACN,MAAM;IACR;IACA,UAAU;QACR,MAAM;QACN,SAAS;IACX;IACA,0BAA0B;IAC1B,uBAAuB;QACrB,MAAM;QACN,MAAM;IACR;IACA,aAAa;QACX,MAAM;QACN,MAAM;YAAC;YAAW;YAAO;SAAiB;IAC5C;IACA,iBAAiB;QACf;YACE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;YAC3B,KAAK;QACP;KACD;IACD,kBAAkB;QAChB;YACE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;YAC3B,KAAK;QACP;KACD;IACD,0BAA0B;IAC1B,SAAS;QACP,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAC3B,KAAK;QACL,OAAO;IACT;IACA,QAAQ;QACN,MAAM;QACN,KAAK;IACP;IACA,YAAY;QACV,MAAM;QACN,MAAM;IACR;IACA,aAAa;QACX,MAAM;QACN,MAAM;IACR;IACA,yCAAyC;IACzC,WAAW;QACT,MAAM;QACN,MAAM;IACR;IACA,SAAS;QACP,MAAM;QACN,MAAM;IACR;IACA,YAAY;QACV,MAAM;QACN,MAAM;IACR;IACA,iBAAiB;QACf;YACE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;YAC3B,KAAK;QACP;KACD;IACD,gBAAgB;QACd;YACE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;YAC3B,KAAK;QACP;KACD;IACD,UAAU;QACR;YACE,UAAU;gBACR,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;gBAC3B,KAAK;YACP;YACA,kBAAkB;gBAChB,MAAM;gBACN,SAAS;YACX;YACA,cAAc;gBACZ,MAAM;gBACN,SAAS;YACX;YACA,cAAc;gBACZ,MAAM;gBACN,SAAS,KAAK,GAAG;YACnB;QACF;KACD;AACH,GACA;IACE,YAAY;AACd;AAGF,uCAAuC;AACvC,WAAW,KAAK,CAAC;IAAE,MAAM;AAAE;AAC3B,WAAW,KAAK,CAAC;IAAE,UAAU;IAAG,MAAM;AAAE;AACxC,wDAAwD;AAExD,MAAM,OACJ,oHAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,oHAAQ,CAAC,KAAK,CAAQ,QAAQ;uCAEzC"}},
    {"offset": {"line": 904, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/lib/mongodb.ts"],"sourcesContent":["import mongoose from 'mongoose';\n\nconst MONGODB_URI = process.env.MONGODB_URI as string;\n\nif (!MONGODB_URI) {\n  throw new Error(\n    'Please define the MONGODB_URI environment variable inside .env.local'\n  );\n}\n\n/**\n * Global is used here to maintain a cached connection across hot reloads\n * in development. This prevents connections growing exponentially\n * during API Route usage.\n */\ninterface MongooseCache {\n  conn: typeof mongoose | null;\n  promise: Promise<typeof mongoose> | null;\n}\n\ndeclare global {\n  var mongoose: MongooseCache | undefined;\n}\n\nlet cached: MongooseCache = global.mongoose || { conn: null, promise: null };\n\nif (!global.mongoose) {\n  global.mongoose = cached;\n}\n\nasync function connectDB(): Promise<typeof mongoose> {\n  if (cached.conn) {\n    return cached.conn;\n  }\n\n  if (!cached.promise) {\n    const opts = {\n      bufferCommands: false,\n      serverSelectionTimeoutMS: 30000,\n      socketTimeoutMS: 75000,\n      connectTimeoutMS: 30000,\n      maxPoolSize: 10,\n      minPoolSize: 1,\n      retryWrites: true,\n      retryReads: true,\n      // Disable TLS validation to fix Node.js 22 SSL error\n      tls: true,\n      tlsAllowInvalidCertificates: true,\n      tlsAllowInvalidHostnames: true,\n    };\n\n    cached.promise = mongoose.connect(MONGODB_URI, opts).then((mongoose) => {\n      console.log('✅ MongoDB connected successfully');\n      return mongoose;\n    }).catch((err) => {\n      console.error('❌ MongoDB connection error:', err.message);\n      cached.promise = null;\n      throw err;\n    });\n  }\n\n  try {\n    cached.conn = await cached.promise;\n  } catch (e) {\n    cached.promise = null;\n    console.error('❌ MongoDB connection error:', e);\n    throw e;\n  }\n\n  return cached.conn;\n}\n\nexport default connectDB;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW;AAE3C,IAAI,CAAC,aAAa;IAChB,MAAM,IAAI,MACR;AAEJ;AAgBA,IAAI,SAAwB,OAAO,QAAQ,IAAI;IAAE,MAAM;IAAM,SAAS;AAAK;AAE3E,IAAI,CAAC,OAAO,QAAQ,EAAE;IACpB,OAAO,QAAQ,GAAG;AACpB;AAEA,eAAe;IACb,IAAI,OAAO,IAAI,EAAE;QACf,OAAO,OAAO,IAAI;IACpB;IAEA,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,OAAO;YACX,gBAAgB;YAChB,0BAA0B;YAC1B,iBAAiB;YACjB,kBAAkB;YAClB,aAAa;YACb,aAAa;YACb,aAAa;YACb,YAAY;YACZ,qDAAqD;YACrD,KAAK;YACL,6BAA6B;YAC7B,0BAA0B;QAC5B;QAEA,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,aAAa,MAAM,IAAI,CAAC,CAAC;YACzD,QAAQ,GAAG,CAAC;YACZ,OAAO;QACT,GAAG,KAAK,CAAC,CAAC;YACR,QAAQ,KAAK,CAAC,+BAA+B,IAAI,OAAO;YACxD,OAAO,OAAO,GAAG;YACjB,MAAM;QACR;IACF;IAEA,IAAI;QACF,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IACpC,EAAE,OAAO,GAAG;QACV,OAAO,OAAO,GAAG;QACjB,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,MAAM;IACR;IAEA,OAAO,OAAO,IAAI;AACpB;uCAEe"}},
    {"offset": {"line": 963, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/app/api/principal/marks/route.ts"],"sourcesContent":["import { authenticateAndAuthorize } from '@/lib/auth-middleware';\nimport Mark from '@/lib/models/Mark';\nimport User from '@/lib/models/User';\nimport connectDB from '@/lib/mongodb';\nimport { NextRequest, NextResponse } from 'next/server';\n\n// GET - List marks/grades\nexport async function GET(request: NextRequest) {\n  try {\n    const authResult = authenticateAndAuthorize(request, {\n      requiredRoles: ['principal', 'teacher', 'student', 'super-admin'],\n    });\n\n    if (authResult instanceof NextResponse) {\n      return authResult;\n    }\n\n    const user = authResult;\n    await connectDB();\n\n    const { searchParams } = new URL(request.url);\n    const className = searchParams.get('className');\n    const subject = searchParams.get('subject');\n    const term = searchParams.get('term');\n    const studentId = searchParams.get('studentId');\n    const examType = searchParams.get('examType');\n\n    // Build query\n    const query: any = {};\n\n    // School filtering\n    if (user.role === 'principal' || user.role === 'teacher') {\n      query.schoolId = user.schoolId;\n    }\n\n    // Student can only see their own marks\n    if (user.role === 'student') {\n      query.studentId = user.id;\n    }\n\n    // Teacher can only see marks for their assigned classes/subjects\n    if (user.role === 'teacher') {\n      const teacherData = await User.findById(user.id).select('assignedClasses assignedSubjects');\n      if (teacherData) {\n        if (teacherData.assignedClasses) {\n          query.className = { $in: teacherData.assignedClasses };\n        }\n        if (teacherData.assignedSubjects) {\n          query.subject = { $in: teacherData.assignedSubjects };\n        }\n      }\n    }\n\n    // Filters\n    if (className) query.className = className;\n    if (subject) query.subject = subject;\n    if (term) query.term = term;\n    if (studentId) query.studentId = studentId;\n    if (examType) query.examType = examType;\n\n    const marks = await Mark.find(query)\n      .populate('studentId', 'name email rollNumber className')\n      .populate('markedBy', 'name email')\n      .sort({ examDate: -1, className: 1, subject: 1 })\n      .limit(500);\n\n    // Calculate statistics if viewing all marks for a class\n    let statistics = null;\n    if (className && !studentId) {\n      const classMarks = marks.filter(m => m.className === className);\n      if (classMarks.length > 0) {\n        const avgPercentage = classMarks.reduce((sum, m) => sum + m.percentage, 0) / classMarks.length;\n        const passed = classMarks.filter(m => m.percentage >= 40).length;\n        const failed = classMarks.length - passed;\n\n        statistics = {\n          totalStudents: classMarks.length,\n          averagePercentage: Math.round(avgPercentage * 100) / 100,\n          passed,\n          failed,\n          passPercentage: Math.round((passed / classMarks.length) * 100),\n        };\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      marks,\n      count: marks.length,\n      statistics,\n    });\n\n  } catch (error: any) {\n    console.error('Marks fetch error:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch marks', details: error.message },\n      { status: 500 }\n    );\n  }\n}\n\n// POST - Create marks (single or bulk)\nexport async function POST(request: NextRequest) {\n  try {\n    const authResult = authenticateAndAuthorize(request, {\n      requiredRoles: ['principal', 'teacher', 'super-admin'],\n    });\n\n    if (authResult instanceof NextResponse) {\n      return authResult;\n    }\n\n    const user = authResult;\n    await connectDB();\n\n    const { records } = await request.json();\n\n    if (!records || !Array.isArray(records) || records.length === 0) {\n      return NextResponse.json(\n        { error: 'Records array is required' },\n        { status: 400 }\n      );\n    }\n\n    // Validate and prepare records\n    const preparedRecords = [];\n\n    for (const record of records) {\n      const {\n        studentId,\n        className,\n        subject,\n        examType,\n        examName,\n        marksObtained,\n        totalMarks,\n        term,\n        examDate,\n        remarks\n      } = record;\n\n      if (!studentId || !className || !subject || !examType || !examName ||\n          marksObtained === undefined || !totalMarks || !term || !examDate) {\n        return NextResponse.json(\n          { error: 'Missing required fields in one or more records' },\n          { status: 400 }\n        );\n      }\n\n      if (marksObtained > totalMarks) {\n        return NextResponse.json(\n          { error: `Marks obtained (${marksObtained}) cannot exceed total marks (${totalMarks})` },\n          { status: 400 }\n        );\n      }\n\n      // Verify student exists and belongs to same school\n      const student = await User.findById(studentId);\n      if (!student || student.role !== 'student') {\n        return NextResponse.json(\n          { error: `Student not found: ${studentId}` },\n          { status: 404 }\n        );\n      }\n\n      if (user.role !== 'super-admin' && student.schoolId?.toString() !== user.schoolId) {\n        return NextResponse.json(\n          { error: 'Cannot enter marks for students from other schools' },\n          { status: 403 }\n        );\n      }\n\n      preparedRecords.push({\n        studentId,\n        schoolId: student.schoolId,\n        className,\n        subject,\n        examType,\n        examName,\n        marksObtained,\n        totalMarks,\n        term,\n        examDate: new Date(examDate),\n        remarks: remarks || '',\n        markedBy: user.id,\n      });\n    }\n\n    const createdMarks = await Mark.insertMany(preparedRecords);\n\n    return NextResponse.json({\n      success: true,\n      message: `Created marks for ${createdMarks.length} student(s)`,\n      marks: createdMarks,\n      count: createdMarks.length,\n    });\n\n  } catch (error: any) {\n    console.error('Marks creation error:', error);\n    return NextResponse.json(\n      { error: 'Failed to create marks', details: error.message },\n      { status: 500 }\n    );\n  }\n}\n\n// PUT - Update marks\nexport async function PUT(request: NextRequest) {\n  try {\n    const authResult = authenticateAndAuthorize(request, {\n      requiredRoles: ['principal', 'teacher', 'super-admin'],\n    });\n\n    if (authResult instanceof NextResponse) {\n      return authResult;\n    }\n\n    const user = authResult;\n    await connectDB();\n\n    const { markId, marksObtained, remarks } = await request.json();\n\n    if (!markId) {\n      return NextResponse.json(\n        { error: 'Mark ID is required' },\n        { status: 400 }\n      );\n    }\n\n    const mark = await Mark.findById(markId);\n    if (!mark) {\n      return NextResponse.json(\n        { error: 'Mark record not found' },\n        { status: 404 }\n      );\n    }\n\n    // Check school access\n    if (user.role !== 'super-admin' && mark.schoolId?.toString() !== user.schoolId) {\n      return NextResponse.json(\n        { error: 'Access denied' },\n        { status: 403 }\n      );\n    }\n\n    if (marksObtained !== undefined) {\n      if (marksObtained > mark.totalMarks) {\n        return NextResponse.json(\n          { error: `Marks obtained (${marksObtained}) cannot exceed total marks (${mark.totalMarks})` },\n          { status: 400 }\n        );\n      }\n      mark.marksObtained = marksObtained;\n    }\n\n    if (remarks !== undefined) {\n      mark.remarks = remarks;\n    }\n\n    await mark.save(); // Will trigger pre-save hook to recalculate percentage and grade\n\n    return NextResponse.json({\n      success: true,\n      message: 'Marks updated successfully',\n      mark,\n    });\n\n  } catch (error: any) {\n    console.error('Marks update error:', error);\n    return NextResponse.json(\n      { error: 'Failed to update marks', details: error.message },\n      { status: 500 }\n    );\n  }\n}\n\n// DELETE - Delete marks\nexport async function DELETE(request: NextRequest) {\n  try {\n    const authResult = authenticateAndAuthorize(request, {\n      requiredRoles: ['principal', 'super-admin'],\n    });\n\n    if (authResult instanceof NextResponse) {\n      return authResult;\n    }\n\n    const user = authResult;\n    await connectDB();\n\n    const { searchParams } = new URL(request.url);\n    const markId = searchParams.get('markId');\n\n    if (!markId) {\n      return NextResponse.json(\n        { error: 'Mark ID is required' },\n        { status: 400 }\n      );\n    }\n\n    const mark = await Mark.findById(markId);\n    if (!mark) {\n      return NextResponse.json(\n        { error: 'Mark record not found' },\n        { status: 404 }\n      );\n    }\n\n    // Check school access\n    if (user.role !== 'super-admin' && mark.schoolId?.toString() !== user.schoolId) {\n      return NextResponse.json(\n        { error: 'Access denied' },\n        { status: 403 }\n      );\n    }\n\n    await Mark.findByIdAndDelete(markId);\n\n    return NextResponse.json({\n      success: true,\n      message: 'Mark record deleted successfully',\n    });\n\n  } catch (error: any) {\n    console.error('Marks deletion error:', error);\n    return NextResponse.json(\n      { error: 'Failed to delete mark', details: error.message },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAGO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,aAAa,IAAA,uJAAwB,EAAC,SAAS;YACnD,eAAe;gBAAC;gBAAa;gBAAW;gBAAW;aAAc;QACnE;QAEA,IAAI,sBAAsB,+QAAY,EAAE;YACtC,OAAO;QACT;QAEA,MAAM,OAAO;QACb,MAAM,IAAA,2HAAS;QAEf,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,YAAY,aAAa,GAAG,CAAC;QACnC,MAAM,UAAU,aAAa,GAAG,CAAC;QACjC,MAAM,OAAO,aAAa,GAAG,CAAC;QAC9B,MAAM,YAAY,aAAa,GAAG,CAAC;QACnC,MAAM,WAAW,aAAa,GAAG,CAAC;QAElC,cAAc;QACd,MAAM,QAAa,CAAC;QAEpB,mBAAmB;QACnB,IAAI,KAAK,IAAI,KAAK,eAAe,KAAK,IAAI,KAAK,WAAW;YACxD,MAAM,QAAQ,GAAG,KAAK,QAAQ;QAChC;QAEA,uCAAuC;QACvC,IAAI,KAAK,IAAI,KAAK,WAAW;YAC3B,MAAM,SAAS,GAAG,KAAK,EAAE;QAC3B;QAEA,iEAAiE;QACjE,IAAI,KAAK,IAAI,KAAK,WAAW;YAC3B,MAAM,cAAc,MAAM,kIAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,EAAE,MAAM,CAAC;YACxD,IAAI,aAAa;gBACf,IAAI,YAAY,eAAe,EAAE;oBAC/B,MAAM,SAAS,GAAG;wBAAE,KAAK,YAAY,eAAe;oBAAC;gBACvD;gBACA,IAAI,YAAY,gBAAgB,EAAE;oBAChC,MAAM,OAAO,GAAG;wBAAE,KAAK,YAAY,gBAAgB;oBAAC;gBACtD;YACF;QACF;QAEA,UAAU;QACV,IAAI,WAAW,MAAM,SAAS,GAAG;QACjC,IAAI,SAAS,MAAM,OAAO,GAAG;QAC7B,IAAI,MAAM,MAAM,IAAI,GAAG;QACvB,IAAI,WAAW,MAAM,SAAS,GAAG;QACjC,IAAI,UAAU,MAAM,QAAQ,GAAG;QAE/B,MAAM,QAAQ,MAAM,kIAAI,CAAC,IAAI,CAAC,OAC3B,QAAQ,CAAC,aAAa,mCACtB,QAAQ,CAAC,YAAY,cACrB,IAAI,CAAC;YAAE,UAAU,CAAC;YAAG,WAAW;YAAG,SAAS;QAAE,GAC9C,KAAK,CAAC;QAET,wDAAwD;QACxD,IAAI,aAAa;QACjB,IAAI,aAAa,CAAC,WAAW;YAC3B,MAAM,aAAa,MAAM,MAAM,CAAC,CAAA,IAAK,EAAE,SAAS,KAAK;YACrD,IAAI,WAAW,MAAM,GAAG,GAAG;gBACzB,MAAM,gBAAgB,WAAW,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,UAAU,EAAE,KAAK,WAAW,MAAM;gBAC9F,MAAM,SAAS,WAAW,MAAM,CAAC,CAAA,IAAK,EAAE,UAAU,IAAI,IAAI,MAAM;gBAChE,MAAM,SAAS,WAAW,MAAM,GAAG;gBAEnC,aAAa;oBACX,eAAe,WAAW,MAAM;oBAChC,mBAAmB,KAAK,KAAK,CAAC,gBAAgB,OAAO;oBACrD;oBACA;oBACA,gBAAgB,KAAK,KAAK,CAAC,AAAC,SAAS,WAAW,MAAM,GAAI;gBAC5D;YACF;QACF;QAEA,OAAO,+QAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT;YACA,OAAO,MAAM,MAAM;YACnB;QACF;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,+QAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAyB,SAAS,MAAM,OAAO;QAAC,GACzD;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,aAAa,IAAA,uJAAwB,EAAC,SAAS;YACnD,eAAe;gBAAC;gBAAa;gBAAW;aAAc;QACxD;QAEA,IAAI,sBAAsB,+QAAY,EAAE;YACtC,OAAO;QACT;QAEA,MAAM,OAAO;QACb,MAAM,IAAA,2HAAS;QAEf,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEtC,IAAI,CAAC,WAAW,CAAC,MAAM,OAAO,CAAC,YAAY,QAAQ,MAAM,KAAK,GAAG;YAC/D,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA4B,GACrC;gBAAE,QAAQ;YAAI;QAElB;QAEA,+BAA+B;QAC/B,MAAM,kBAAkB,EAAE;QAE1B,KAAK,MAAM,UAAU,QAAS;YAC5B,MAAM,EACJ,SAAS,EACT,SAAS,EACT,OAAO,EACP,QAAQ,EACR,QAAQ,EACR,aAAa,EACb,UAAU,EACV,IAAI,EACJ,QAAQ,EACR,OAAO,EACR,GAAG;YAEJ,IAAI,CAAC,aAAa,CAAC,aAAa,CAAC,WAAW,CAAC,YAAY,CAAC,YACtD,kBAAkB,aAAa,CAAC,cAAc,CAAC,QAAQ,CAAC,UAAU;gBACpE,OAAO,+QAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;gBAAiD,GAC1D;oBAAE,QAAQ;gBAAI;YAElB;YAEA,IAAI,gBAAgB,YAAY;gBAC9B,OAAO,+QAAY,CAAC,IAAI,CACtB;oBAAE,OAAO,CAAC,gBAAgB,EAAE,cAAc,6BAA6B,EAAE,WAAW,CAAC,CAAC;gBAAC,GACvF;oBAAE,QAAQ;gBAAI;YAElB;YAEA,mDAAmD;YACnD,MAAM,UAAU,MAAM,kIAAI,CAAC,QAAQ,CAAC;YACpC,IAAI,CAAC,WAAW,QAAQ,IAAI,KAAK,WAAW;gBAC1C,OAAO,+QAAY,CAAC,IAAI,CACtB;oBAAE,OAAO,CAAC,mBAAmB,EAAE,WAAW;gBAAC,GAC3C;oBAAE,QAAQ;gBAAI;YAElB;YAEA,IAAI,KAAK,IAAI,KAAK,iBAAiB,QAAQ,QAAQ,EAAE,eAAe,KAAK,QAAQ,EAAE;gBACjF,OAAO,+QAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;gBAAqD,GAC9D;oBAAE,QAAQ;gBAAI;YAElB;YAEA,gBAAgB,IAAI,CAAC;gBACnB;gBACA,UAAU,QAAQ,QAAQ;gBAC1B;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA,UAAU,IAAI,KAAK;gBACnB,SAAS,WAAW;gBACpB,UAAU,KAAK,EAAE;YACnB;QACF;QAEA,MAAM,eAAe,MAAM,kIAAI,CAAC,UAAU,CAAC;QAE3C,OAAO,+QAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS,CAAC,kBAAkB,EAAE,aAAa,MAAM,CAAC,WAAW,CAAC;YAC9D,OAAO;YACP,OAAO,aAAa,MAAM;QAC5B;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,+QAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAA0B,SAAS,MAAM,OAAO;QAAC,GAC1D;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,aAAa,IAAA,uJAAwB,EAAC,SAAS;YACnD,eAAe;gBAAC;gBAAa;gBAAW;aAAc;QACxD;QAEA,IAAI,sBAAsB,+QAAY,EAAE;YACtC,OAAO;QACT;QAEA,MAAM,OAAO;QACb,MAAM,IAAA,2HAAS;QAEf,MAAM,EAAE,MAAM,EAAE,aAAa,EAAE,OAAO,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE7D,IAAI,CAAC,QAAQ;YACX,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsB,GAC/B;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,kIAAI,CAAC,QAAQ,CAAC;QACjC,IAAI,CAAC,MAAM;YACT,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAwB,GACjC;gBAAE,QAAQ;YAAI;QAElB;QAEA,sBAAsB;QACtB,IAAI,KAAK,IAAI,KAAK,iBAAiB,KAAK,QAAQ,EAAE,eAAe,KAAK,QAAQ,EAAE;YAC9E,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAgB,GACzB;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,kBAAkB,WAAW;YAC/B,IAAI,gBAAgB,KAAK,UAAU,EAAE;gBACnC,OAAO,+QAAY,CAAC,IAAI,CACtB;oBAAE,OAAO,CAAC,gBAAgB,EAAE,cAAc,6BAA6B,EAAE,KAAK,UAAU,CAAC,CAAC,CAAC;gBAAC,GAC5F;oBAAE,QAAQ;gBAAI;YAElB;YACA,KAAK,aAAa,GAAG;QACvB;QAEA,IAAI,YAAY,WAAW;YACzB,KAAK,OAAO,GAAG;QACjB;QAEA,MAAM,KAAK,IAAI,IAAI,iEAAiE;QAEpF,OAAO,+QAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;YACT;QACF;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,+QAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAA0B,SAAS,MAAM,OAAO;QAAC,GAC1D;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,OAAO,OAAoB;IAC/C,IAAI;QACF,MAAM,aAAa,IAAA,uJAAwB,EAAC,SAAS;YACnD,eAAe;gBAAC;gBAAa;aAAc;QAC7C;QAEA,IAAI,sBAAsB,+QAAY,EAAE;YACtC,OAAO;QACT;QAEA,MAAM,OAAO;QACb,MAAM,IAAA,2HAAS;QAEf,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,SAAS,aAAa,GAAG,CAAC;QAEhC,IAAI,CAAC,QAAQ;YACX,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsB,GAC/B;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,kIAAI,CAAC,QAAQ,CAAC;QACjC,IAAI,CAAC,MAAM;YACT,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAwB,GACjC;gBAAE,QAAQ;YAAI;QAElB;QAEA,sBAAsB;QACtB,IAAI,KAAK,IAAI,KAAK,iBAAiB,KAAK,QAAQ,EAAE,eAAe,KAAK,QAAQ,EAAE;YAC9E,OAAO,+QAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAgB,GACzB;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,kIAAI,CAAC,iBAAiB,CAAC;QAE7B,OAAO,+QAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;QACX;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,+QAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAyB,SAAS,MAAM,OAAO;QAAC,GACzD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}