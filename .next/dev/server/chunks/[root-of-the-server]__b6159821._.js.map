{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/lib/permissions.ts"],"sourcesContent":["/**\n * Role-Based Access Control (RBAC) System\n * \n * Role Hierarchy:\n * 1. Super Admin - Platform owner, manages all schools\n * 2. Principal - School-level admin, manages their school\n * 3. Teacher - Manages assigned classes and subjects\n * 4. Student - View-only access to their own data\n */\n\nexport type UserRole = 'super-admin' | 'principal' | 'teacher' | 'student';\n\nexport interface Permission {\n  resource: string;\n  action: 'create' | 'read' | 'update' | 'delete' | 'manage';\n  scope?: 'all' | 'school' | 'own' | 'assigned';\n}\n\n// Define permissions for each role\nexport const rolePermissions: Record<UserRole, Permission[]> = {\n  'super-admin': [\n    // Full platform access\n    { resource: 'schools', action: 'manage', scope: 'all' },\n    { resource: 'users', action: 'manage', scope: 'all' },\n    { resource: 'principals', action: 'create', scope: 'all' },\n    { resource: 'principals', action: 'manage', scope: 'all' },\n    { resource: 'billing', action: 'manage', scope: 'all' },\n    { resource: 'analytics', action: 'read', scope: 'all' },\n    { resource: 'reports', action: 'read', scope: 'all' },\n    { resource: 'school-registrations', action: 'manage', scope: 'all' },\n  ],\n  \n  'principal': [\n    // School-level management\n    { resource: 'school', action: 'read', scope: 'own' },\n    { resource: 'school', action: 'update', scope: 'own' },\n    { resource: 'teachers', action: 'create', scope: 'school' },\n    { resource: 'teachers', action: 'manage', scope: 'school' },\n    { resource: 'students', action: 'create', scope: 'school' },\n    { resource: 'students', action: 'manage', scope: 'school' },\n    { resource: 'classes', action: 'manage', scope: 'school' },\n    { resource: 'subjects', action: 'manage', scope: 'school' },\n    { resource: 'attendance', action: 'read', scope: 'school' },\n    { resource: 'marks', action: 'read', scope: 'school' },\n    { resource: 'reports', action: 'read', scope: 'school' },\n    { resource: 'stats', action: 'read', scope: 'school' },\n    { resource: 'analytics', action: 'read', scope: 'school' },\n    { resource: 'timetable', action: 'manage', scope: 'school' },\n    { resource: 'courses', action: 'manage', scope: 'school' },\n  ],\n  \n  'teacher': [\n    // Class and subject specific access\n    { resource: 'school', action: 'read', scope: 'own' }, // Read-only school info\n    { resource: 'students', action: 'read', scope: 'assigned' }, // Only their class students\n    { resource: 'classes', action: 'read', scope: 'assigned' },\n    { resource: 'subjects', action: 'read', scope: 'assigned' },\n    { resource: 'homework', action: 'manage', scope: 'assigned' },\n    { resource: 'attendance', action: 'create', scope: 'assigned' },\n    { resource: 'attendance', action: 'read', scope: 'assigned' },\n    { resource: 'marks', action: 'create', scope: 'assigned' },\n    { resource: 'marks', action: 'update', scope: 'assigned' },\n    { resource: 'marks', action: 'read', scope: 'assigned' },\n    { resource: 'timetable', action: 'read', scope: 'assigned' },\n    { resource: 'courses', action: 'read', scope: 'assigned' },\n    { resource: 'quizzes', action: 'read', scope: 'assigned' }, // View quiz responses\n  ],\n  \n  'student': [\n    // Personal dashboard only\n    { resource: 'profile', action: 'read', scope: 'own' },\n    { resource: 'profile', action: 'update', scope: 'own' },\n    { resource: 'class', action: 'read', scope: 'own' },\n    { resource: 'subjects', action: 'read', scope: 'own' },\n    { resource: 'teachers', action: 'read', scope: 'own' },\n    { resource: 'homework', action: 'read', scope: 'own' },\n    { resource: 'attendance', action: 'read', scope: 'own' },\n    { resource: 'marks', action: 'read', scope: 'own' },\n    { resource: 'timetable', action: 'read', scope: 'own' },\n    { resource: 'courses', action: 'read', scope: 'own' },\n    { resource: 'quizzes', action: 'read', scope: 'own' },\n    { resource: 'quizzes', action: 'create', scope: 'own' }, // Submit quiz responses\n    { resource: 'school', action: 'read', scope: 'own' }, // Basic school info only\n  ],\n};\n\n/**\n * Check if a user has permission to perform an action\n */\nexport function hasPermission(\n  userRole: UserRole,\n  resource: string,\n  action: 'create' | 'read' | 'update' | 'delete' | 'manage',\n  scope?: 'all' | 'school' | 'own' | 'assigned'\n): boolean {\n  const permissions = rolePermissions[userRole];\n  \n  return permissions.some(permission => {\n    // Check if resource matches\n    const resourceMatch = permission.resource === resource;\n    \n    // Check if action matches (manage includes all actions)\n    const actionMatch = \n      permission.action === action || \n      permission.action === 'manage';\n    \n    // Check if scope matches (if scope is specified)\n    const scopeMatch = !scope || permission.scope === scope || permission.scope === 'all';\n    \n    return resourceMatch && actionMatch && scopeMatch;\n  });\n}\n\n/**\n * Check if user can access a school's data\n */\nexport function canAccessSchool(\n  userRole: UserRole,\n  userSchoolId: string | undefined,\n  targetSchoolId: string\n): boolean {\n  // Super admin can access all schools\n  if (userRole === 'super-admin') {\n    return true;\n  }\n  \n  // Others can only access their own school\n  return userSchoolId === targetSchoolId;\n}\n\n/**\n * Check if user can access another user's data\n */\nexport function canAccessUser(\n  userRole: UserRole,\n  userId: string,\n  targetUserId: string,\n  userSchoolId: string | undefined,\n  targetUserSchoolId: string | undefined,\n  targetUserRole?: UserRole\n): boolean {\n  // Super admin can access all users\n  if (userRole === 'super-admin') {\n    return true;\n  }\n  \n  // Users can always access their own data\n  if (userId === targetUserId) {\n    return true;\n  }\n  \n  // Principal can access all users in their school\n  if (userRole === 'principal' && userSchoolId === targetUserSchoolId) {\n    return true;\n  }\n  \n  // Teachers can access students in their school (will be further filtered by assigned classes)\n  if (\n    userRole === 'teacher' && \n    targetUserRole === 'student' && \n    userSchoolId === targetUserSchoolId\n  ) {\n    return true;\n  }\n  \n  return false;\n}\n\n/**\n * Filter data based on user's role and scope\n */\nexport function getAccessibleSchoolIds(\n  userRole: UserRole,\n  userSchoolId: string | undefined\n): string[] | 'all' {\n  if (userRole === 'super-admin') {\n    return 'all';\n  }\n  \n  if (userSchoolId) {\n    return [userSchoolId];\n  }\n  \n  return [];\n}\n\n/**\n * Get user-friendly role names\n */\nexport const roleLabels: Record<UserRole, string> = {\n  'super-admin': 'Super Administrator',\n  'principal': 'Principal / Head of School',\n  'teacher': 'Teacher',\n  'student': 'Student',\n};\n\n/**\n * Get role descriptions\n */\nexport const roleDescriptions: Record<UserRole, string> = {\n  'super-admin': 'Platform owner with full access to all schools and features',\n  'principal': 'School administrator with full control over their school',\n  'teacher': 'Can manage assigned classes, subjects, and student data',\n  'student': 'View-only access to personal academic information',\n};\n\n/**\n * Get dashboard route based on role\n */\nexport function getDashboardRoute(role: UserRole): string {\n  switch (role) {\n    case 'super-admin':\n      return '/admin/dashboard';\n    case 'principal':\n      return '/principal/dashboard';\n    case 'teacher':\n      return '/teacher/dashboard';\n    case 'student':\n      return '/student/dashboard';\n    default:\n      return '/';\n  }\n}\n\n/**\n * Check if role can create users of target role\n */\nexport function canCreateRole(\n  userRole: UserRole,\n  targetRole: UserRole\n): boolean {\n  if (userRole === 'super-admin') {\n    // Super admin can create principals and approve schools\n    return ['principal', 'super-admin'].includes(targetRole);\n  }\n  \n  if (userRole === 'principal') {\n    // Principal can create teachers and students\n    return ['teacher', 'student'].includes(targetRole);\n  }\n  \n  return false;\n}\n\n/**\n * Middleware helper for API routes\n */\nexport function requireRole(allowedRoles: UserRole[]) {\n  return (userRole: UserRole) => {\n    return allowedRoles.includes(userRole);\n  };\n}\n\n/**\n * Check if user has elevated privileges\n */\nexport function isAdmin(role: UserRole): boolean {\n  return ['super-admin', 'principal'].includes(role);\n}\n\n/**\n * Check if user is super admin\n */\nexport function isSuperAdmin(role: UserRole): boolean {\n  return role === 'super-admin';\n}\n\n/**\n * Check if user is principal\n */\nexport function isPrincipal(role: UserRole): boolean {\n  return role === 'principal';\n}\n\n/**\n * Check if user is teacher\n */\nexport function isTeacher(role: UserRole): boolean {\n  return role === 'teacher';\n}\n\n/**\n * Check if user is student\n */\nexport function isStudent(role: UserRole): boolean {\n  return role === 'student';\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 465, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/lib/auth-middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { UserRole, canAccessSchool, hasPermission } from './permissions';\n\nexport interface AuthUser {\n  id: string;\n  role: UserRole;\n  name: string;\n  email: string;\n  schoolId?: string;\n}\n\n/**\n * Get authenticated user from request cookies\n */\nexport function getAuthUser(request: NextRequest): AuthUser | null {\n  try {\n    const cookie = request.cookies.get('edubridge_session');\n    if (!cookie?.value) {\n      return null;\n    }\n    \n    const session = JSON.parse(cookie.value);\n    return {\n      id: session.id,\n      role: session.role as UserRole,\n      name: session.name,\n      email: session.email,\n      schoolId: session.schoolId,\n    };\n  } catch (error) {\n    return null;\n  }\n}\n\n/**\n * Require authentication - returns 401 if not authenticated\n */\nexport function requireAuth(request: NextRequest): AuthUser | NextResponse {\n  const user = getAuthUser(request);\n  \n  if (!user) {\n    return NextResponse.json(\n      { success: false, error: 'Authentication required' },\n      { status: 401 }\n    );\n  }\n  \n  return user;\n}\n\n/**\n * Require specific role(s) - returns 403 if not authorized\n */\nexport function requireRoles(\n  user: AuthUser,\n  allowedRoles: UserRole[]\n): true | NextResponse {\n  if (!allowedRoles.includes(user.role)) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Insufficient permissions',\n        message: `This action requires one of the following roles: ${allowedRoles.join(', ')}`\n      },\n      { status: 403 }\n    );\n  }\n  \n  return true;\n}\n\n/**\n * Require permission for a resource and action\n */\nexport function requirePermission(\n  user: AuthUser,\n  resource: string,\n  action: 'create' | 'read' | 'update' | 'delete' | 'manage',\n  scope?: 'all' | 'school' | 'own' | 'assigned'\n): true | NextResponse {\n  if (!hasPermission(user.role, resource, action, scope)) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Insufficient permissions',\n        message: `You don't have permission to ${action} ${resource}`\n      },\n      { status: 403 }\n    );\n  }\n  \n  return true;\n}\n\n/**\n * Require school access - returns 403 if user can't access the school\n */\nexport function requireSchoolAccess(\n  user: AuthUser,\n  targetSchoolId: string\n): true | NextResponse {\n  if (!canAccessSchool(user.role, user.schoolId, targetSchoolId)) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Access denied',\n        message: 'You do not have access to this school'\n      },\n      { status: 403 }\n    );\n  }\n  \n  return true;\n}\n\n/**\n * Require same school - ensures user and target are in same school\n */\nexport function requireSameSchool(\n  user: AuthUser,\n  targetSchoolId: string | undefined\n): true | NextResponse {\n  // Super admin can access all schools\n  if (user.role === 'super-admin') {\n    return true;\n  }\n  \n  if (!user.schoolId || !targetSchoolId) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'School information missing',\n      },\n      { status: 400 }\n    );\n  }\n  \n  if (user.schoolId !== targetSchoolId) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Access denied',\n        message: 'You can only access users in your school'\n      },\n      { status: 403 }\n    );\n  }\n  \n  return true;\n}\n\n/**\n * Helper to handle auth checks in API routes\n * Returns user if all checks pass, otherwise returns NextResponse error\n */\nexport function authenticateAndAuthorize(\n  request: NextRequest,\n  options: {\n    requiredRoles?: UserRole[];\n    resource?: string;\n    action?: 'create' | 'read' | 'update' | 'delete' | 'manage';\n    scope?: 'all' | 'school' | 'own' | 'assigned';\n  } = {}\n): AuthUser | NextResponse {\n  // Check authentication\n  const authResult = requireAuth(request);\n  if (authResult instanceof NextResponse) {\n    return authResult;\n  }\n  \n  const user = authResult;\n  \n  // Check role if specified\n  if (options.requiredRoles) {\n    const roleCheck = requireRoles(user, options.requiredRoles);\n    if (roleCheck instanceof NextResponse) {\n      return roleCheck;\n    }\n  }\n  \n  // Check permission if specified\n  if (options.resource && options.action) {\n    const permCheck = requirePermission(\n      user,\n      options.resource,\n      options.action,\n      options.scope\n    );\n    if (permCheck instanceof NextResponse) {\n      return permCheck;\n    }\n  }\n  \n  return user;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 608, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/lib/models/Timetable.ts"],"sourcesContent":["import mongoose, { Document, Model, Schema } from 'mongoose'\n\nexport interface ITimetable extends Document {\n  _id: string\n  classId: mongoose.Types.ObjectId\n  schoolId: mongoose.Types.ObjectId\n  dayOfWeek: 'Monday' | 'Tuesday' | 'Wednesday' | 'Thursday' | 'Friday' | 'Saturday' | 'Sunday'\n  period: number\n  startTime: string\n  endTime: string\n  subjectId: mongoose.Types.ObjectId\n  teacherId: mongoose.Types.ObjectId\n  roomNumber?: string\n  createdAt: Date\n  updatedAt: Date\n}\n\nconst TimetableSchema = new Schema<ITimetable>({\n  classId: { type: Schema.Types.ObjectId, ref: 'Class', required: true, index: true },\n  schoolId: { type: Schema.Types.ObjectId, ref: 'School', required: true, index: true },\n  dayOfWeek: { \n    type: String, \n    required: true,\n    enum: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']\n  },\n  period: { type: Number, required: true, min: 1, max: 10 },\n  startTime: { type: String, required: true },\n  endTime: { type: String, required: true },\n  subjectId: { type: Schema.Types.ObjectId, ref: 'Subject', required: true },\n  teacherId: { type: Schema.Types.ObjectId, ref: 'User', required: true },\n  roomNumber: { type: String, trim: true },\n}, { timestamps: true })\n\nTimetableSchema.index({ classId: 1, dayOfWeek: 1, period: 1 }, { unique: true })\nTimetableSchema.index({ teacherId: 1 })\nTimetableSchema.index({ subjectId: 1 })\n\nconst Timetable: Model<ITimetable> = mongoose.models.Timetable || mongoose.model<ITimetable>('Timetable', TimetableSchema)\nexport default Timetable\n"],"names":[],"mappings":";;;;AAAA;;AAiBA,MAAM,kBAAkB,IAAI,mHAAM,CAAa;IAC7C,SAAS;QAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAS,UAAU;QAAM,OAAO;IAAK;IAClF,UAAU;QAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAU,UAAU;QAAM,OAAO;IAAK;IACpF,WAAW;QACT,MAAM;QACN,UAAU;QACV,MAAM;YAAC;YAAU;YAAW;YAAa;YAAY;YAAU;YAAY;SAAS;IACtF;IACA,QAAQ;QAAE,MAAM;QAAQ,UAAU;QAAM,KAAK;QAAG,KAAK;IAAG;IACxD,WAAW;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC1C,SAAS;QAAE,MAAM;QAAQ,UAAU;IAAK;IACxC,WAAW;QAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAW,UAAU;IAAK;IACzE,WAAW;QAAE,MAAM,mHAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAQ,UAAU;IAAK;IACtE,YAAY;QAAE,MAAM;QAAQ,MAAM;IAAK;AACzC,GAAG;IAAE,YAAY;AAAK;AAEtB,gBAAgB,KAAK,CAAC;IAAE,SAAS;IAAG,WAAW;IAAG,QAAQ;AAAE,GAAG;IAAE,QAAQ;AAAK;AAC9E,gBAAgB,KAAK,CAAC;IAAE,WAAW;AAAE;AACrC,gBAAgB,KAAK,CAAC;IAAE,WAAW;AAAE;AAErC,MAAM,YAA+B,oHAAQ,CAAC,MAAM,CAAC,SAAS,IAAI,oHAAQ,CAAC,KAAK,CAAa,aAAa;uCAC3F"}},
    {"offset": {"line": 690, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/lib/mongodb.ts"],"sourcesContent":["import mongoose from 'mongoose';\n\nconst MONGODB_URI = process.env.MONGODB_URI as string;\n\nif (!MONGODB_URI) {\n  throw new Error(\n    'Please define the MONGODB_URI environment variable inside .env.local'\n  );\n}\n\n/**\n * Global is used here to maintain a cached connection across hot reloads\n * in development. This prevents connections growing exponentially\n * during API Route usage.\n */\ninterface MongooseCache {\n  conn: typeof mongoose | null;\n  promise: Promise<typeof mongoose> | null;\n}\n\ndeclare global {\n  var mongoose: MongooseCache | undefined;\n}\n\nlet cached: MongooseCache = global.mongoose || { conn: null, promise: null };\n\nif (!global.mongoose) {\n  global.mongoose = cached;\n}\n\nasync function connectDB(): Promise<typeof mongoose> {\n  if (cached.conn) {\n    return cached.conn;\n  }\n\n  if (!cached.promise) {\n    const opts = {\n      bufferCommands: false,\n      serverSelectionTimeoutMS: 30000,\n      socketTimeoutMS: 75000,\n      connectTimeoutMS: 30000,\n      maxPoolSize: 10,\n      minPoolSize: 1,\n      retryWrites: true,\n      retryReads: true,\n      // Disable TLS validation to fix Node.js 22 SSL error\n      tls: true,\n      tlsAllowInvalidCertificates: true,\n      tlsAllowInvalidHostnames: true,\n    };\n\n    cached.promise = mongoose.connect(MONGODB_URI, opts).then((mongoose) => {\n      console.log('✅ MongoDB connected successfully');\n      return mongoose;\n    }).catch((err) => {\n      console.error('❌ MongoDB connection error:', err.message);\n      cached.promise = null;\n      throw err;\n    });\n  }\n\n  try {\n    cached.conn = await cached.promise;\n  } catch (e) {\n    cached.promise = null;\n    console.error('❌ MongoDB connection error:', e);\n    throw e;\n  }\n\n  return cached.conn;\n}\n\nexport default connectDB;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW;AAE3C,IAAI,CAAC,aAAa;IAChB,MAAM,IAAI,MACR;AAEJ;AAgBA,IAAI,SAAwB,OAAO,QAAQ,IAAI;IAAE,MAAM;IAAM,SAAS;AAAK;AAE3E,IAAI,CAAC,OAAO,QAAQ,EAAE;IACpB,OAAO,QAAQ,GAAG;AACpB;AAEA,eAAe;IACb,IAAI,OAAO,IAAI,EAAE;QACf,OAAO,OAAO,IAAI;IACpB;IAEA,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,OAAO;YACX,gBAAgB;YAChB,0BAA0B;YAC1B,iBAAiB;YACjB,kBAAkB;YAClB,aAAa;YACb,aAAa;YACb,aAAa;YACb,YAAY;YACZ,qDAAqD;YACrD,KAAK;YACL,6BAA6B;YAC7B,0BAA0B;QAC5B;QAEA,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,aAAa,MAAM,IAAI,CAAC,CAAC;YACzD,QAAQ,GAAG,CAAC;YACZ,OAAO;QACT,GAAG,KAAK,CAAC,CAAC;YACR,QAAQ,KAAK,CAAC,+BAA+B,IAAI,OAAO;YACxD,OAAO,OAAO,GAAG;YACjB,MAAM;QACR;IACF;IAEA,IAAI;QACF,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IACpC,EAAE,OAAO,GAAG;QACV,OAAO,OAAO,GAAG;QACjB,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,MAAM;IACR;IAEA,OAAO,OAAO,IAAI;AACpB;uCAEe"}},
    {"offset": {"line": 749, "column": 0}, "map": {"version":3,"sources":["file:///E:/projects/edu-bridge-ai-platform/app/api/principal/timetable/route.ts"],"sourcesContent":["import { authenticateAndAuthorize } from '@/lib/auth-middleware'\nimport Timetable from '@/lib/models/Timetable'\nimport connectDB from '@/lib/mongodb'\nimport { NextRequest, NextResponse } from 'next/server'\n\n// GET - List timetable entries\nexport async function GET(request: NextRequest) {\n  try {\n    const authResult = authenticateAndAuthorize(request, {\n      requiredRoles: ['principal', 'teacher', 'student', 'super-admin'],\n      resource: 'timetable',\n      action: 'read',\n    })\n\n    if (authResult instanceof NextResponse) {\n      return authResult\n    }\n\n    const user = authResult\n    await connectDB()\n\n    const { searchParams } = new URL(request.url)\n    const classId = searchParams.get('classId')\n    const dayOfWeek = searchParams.get('dayOfWeek')\n    const teacherId = searchParams.get('teacherId')\n\n    // Build query\n    const query: any = {}\n\n    // School filtering for principal and teacher\n    if (user.role === 'principal' || user.role === 'teacher') {\n      if (!user.schoolId) {\n        return NextResponse.json(\n          { success: false, error: 'School information missing' },\n          { status: 400 }\n        )\n      }\n      query.schoolId = user.schoolId\n    }\n\n    // Filters\n    if (classId) query.classId = classId\n    if (dayOfWeek) query.dayOfWeek = dayOfWeek\n    if (teacherId) query.teacherId = teacherId\n\n    const timetable = await Timetable.find(query)\n      .populate('classId', 'className section grade')\n      .populate('subjectId', 'name')\n      .populate('teacherId', 'name email')\n      .sort({ dayOfWeek: 1, period: 1 })\n\n    return NextResponse.json({\n      success: true,\n      timetable,\n      count: timetable.length,\n    })\n  } catch (error: any) {\n    console.error('Timetable API Error:', error)\n    return NextResponse.json(\n      { success: false, error: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAGO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,aAAa,IAAA,uJAAwB,EAAC,SAAS;YACnD,eAAe;gBAAC;gBAAa;gBAAW;gBAAW;aAAc;YACjE,UAAU;YACV,QAAQ;QACV;QAEA,IAAI,sBAAsB,+QAAY,EAAE;YACtC,OAAO;QACT;QAEA,MAAM,OAAO;QACb,MAAM,IAAA,2HAAS;QAEf,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,UAAU,aAAa,GAAG,CAAC;QACjC,MAAM,YAAY,aAAa,GAAG,CAAC;QACnC,MAAM,YAAY,aAAa,GAAG,CAAC;QAEnC,cAAc;QACd,MAAM,QAAa,CAAC;QAEpB,6CAA6C;QAC7C,IAAI,KAAK,IAAI,KAAK,eAAe,KAAK,IAAI,KAAK,WAAW;YACxD,IAAI,CAAC,KAAK,QAAQ,EAAE;gBAClB,OAAO,+QAAY,CAAC,IAAI,CACtB;oBAAE,SAAS;oBAAO,OAAO;gBAA6B,GACtD;oBAAE,QAAQ;gBAAI;YAElB;YACA,MAAM,QAAQ,GAAG,KAAK,QAAQ;QAChC;QAEA,UAAU;QACV,IAAI,SAAS,MAAM,OAAO,GAAG;QAC7B,IAAI,WAAW,MAAM,SAAS,GAAG;QACjC,IAAI,WAAW,MAAM,SAAS,GAAG;QAEjC,MAAM,YAAY,MAAM,uIAAS,CAAC,IAAI,CAAC,OACpC,QAAQ,CAAC,WAAW,2BACpB,QAAQ,CAAC,aAAa,QACtB,QAAQ,CAAC,aAAa,cACtB,IAAI,CAAC;YAAE,WAAW;YAAG,QAAQ;QAAE;QAElC,OAAO,+QAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT;YACA,OAAO,UAAU,MAAM;QACzB;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,+QAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC,GACvC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}